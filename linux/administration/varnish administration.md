# Varnish administration

Documentation, monitoring, and troubleshooting information for the Varnish cache server

_"Varnish is a web application accelerator. You install it in front of your web application and it will speed it up significantly." - varnish website_

## Huck Implementation

[Varnish](https://www.varnish-cache.org/) is installed on www.huck.psu.edu to cache the pages generated by Plone and speed up the experience for site visitors. The configuration also acts as a load balancer for the multiple zope clients that power Plone. Varnish is configured to monitor these zope clients so it can detect when they go offline and it stops using them.

### Configuration settings

* The site-specific settings are stored in _/etc/varnish/default.vcl_
* The daemon-specific settings like what ports to use and which configuration file to read are stored in _/etc/default/varnish_

### Specific features enabled/configured

* Manual purge request using a force reload in the browser - to force a reload you hold down the SHIFT key and click the reload/refresh button in the browser.
* Plone is configured to cause a purge for any object that is edited - when you save something in Plone, it instructs Varnish to throw away the old cached copy and cache a new one when requested. This does not effect any folder or collection that the object appears in, those remain cached.
* Grace period of 2 hours if the server is overwhelmed - if the backend stops responding, Varnish will continue to server cached files 2 hours after it's supposed to have thrown them away. This is called "saint mode".
* Custom 503 error message
* Round-robin load balancing among 4 zope clients.
* Checks the health of each zope client (by accessing the _/huck/about_ page) every 10 seconds. Once a client fails a check, it must report healthy 3 times in a row before Varnish will start using it again.

## Monitoring the zope clients

Varnish is capable of [monitoring the health of the backend services](https://www.varnish-cache.org/trac/wiki/BackendPolling) that it's caching. The Huck implementation takes advantage of this and is based on [Nathan VanGheem's High Availability Varnish Configuration for Plone](http://nathanvangheem.com/news/high-availability-varnish-configuration-for-plone) documentation.

The URL that Varnish monitors was specifically chosen to **not be** the home page and to be an easy to render page within the plone site. This should help keep the load of all the health checks from negatively affecting the performance of the zope clients.

## Custom 503 error message

Varnish has really ugly error messages that are not friendly at all to website visitors. Since the 503 Service Unavailable is the most common error that Varnish responds with, it has been customized in our configuration so that the message is helpful, friendly, and styled to look like the rest of the website. This error is returned any time Varnish cannot find or get the requested page.

This custom error message is configured at the end of the _/etc/varnish/default.vcl_ file and loads an outside HTML document to be displayed.

## Logging

Varnish produces a lot of real-time information as it runs and outputting all of this to a permanent log file would take up entirely too much disk space. Varnish instead logs to a shared memory segment and you can use various tools provided with Varnish to watch this information in real-time.

The [varnish logs](https://www.varnish-cache.org/docs/3.0/tutorial/logging.html) are accessed primarily via the **varnishlog** command which will spew information in real-time to the screen until stopped. There are other [Varnish programs](https://www.varnish-software.com/static/book/Appendix_A__Varnish_Programs.html) that can be used to monitor the daemon such as:

* **varnishncsa** - prints the varnish logs in Apache-like (NCSA) format
* **varnishstat** - outputs the various counters (hits, misses, threads, deleted objects, etc) that Varnish tracks
* **varnishhist** - produces continuously updated histogram of the last N requests
* **varnishtop** - groups information into a sorted list of most frequent information
* **varnishsizes** - same as varnishhist but based on the size of the objects not the time required to complete the request

## Useful log commands

* What URLs are being requested from the backend most?

        varnishtop -i TxUrl

* What URLs are being requested from the client most?

        varnishtop -i RxUrl

* View a request coming from the client for a specific URL (i.e., /foo/bar)

        varnishlog -c -m 'RxURL:^/foo/bar'

* List of statuses received from the backend

        varnishtop -i RxStatus

* List of statuses returned to the clients

        varnishtop -i TxStatus

* Display all 503 Service Unavailable errors returned to clients

        varnishlog -c -m TxStatus:503

## Flushing the cache

You may need to completely clear the Varnish cache at some point. Simply restart the Varnish daemon

    sudo service varnish restart

## Additional information

SeeÂ [the varnish documentation](https://www.varnish-cache.org/docs/3.0/).
